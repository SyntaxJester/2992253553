name: Daily Update
on:
  schedule:
    - cron: '0 0 * * *' # æ¯å¤© UTC æ—¶é—´ 00:00 è¿è¡Œ
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

# ğŸ‘‡ å…³é”®ä¿®æ”¹ï¼šæˆäºˆ GITHUB_TOKEN å†™å…¥æƒé™ (è™½ç„¶ä½ ç”¨äº† PATï¼Œä½†æ˜¾å¼å£°æ˜æ›´æ¸…æ™°)
permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 # å»ºè®®ä½¿ç”¨æœ€æ–°çš„ actions/checkout ç‰ˆæœ¬
        with:
          token: ${{ secrets.PAT_FOR_PUSH }}

      - name: Install
        run: yarn

      - name: Update # è¿è¡Œä½ çš„ daily.js è„šæœ¬ï¼Œå®ƒåº”è¯¥ç”Ÿæˆ daily_quotation.txt
        run: node daily.js

      # ğŸ‘‡ æ–°å¢æ­¥éª¤ï¼šè¯»å–ç”Ÿæˆçš„æ¯æ—¥ä¸€è¨€å†…å®¹å¹¶æ’å…¥åˆ° README.md
      - name: Insert Daily Quotation into README
        run: |
          # æ£€æŸ¥ daily_quotation.txt æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
          if [ -f daily_quotation.txt ] && [ -s daily_quotation.txt ]; then
            # è¯»å– daily_quotation.txt çš„å†…å®¹
            NEW_QUOTATION_BLOCK=$(cat daily_quotation.txt)
            echo "Found new quotation block to insert:"
            echo "$NEW_QUOTATION_BLOCK"
          else
            echo "daily_quotation.txt does not exist or is empty. Skipping insertion."
            exit 0 # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œåˆ™ä¸è¿›è¡Œä»»ä½•æ“ä½œï¼Œç›´æ¥é€€å‡º
          fi

          # è¯»å–å½“å‰ README.md å†…å®¹
          README_CONTENT=$(cat README.md)

          # ä½¿ç”¨ sed åœ¨ "æˆ‘å« Privat5418" å’Œ "å¾ˆé«˜å…´è®¤è¯†ä½ " ä¹‹é—´æ’å…¥æ–°å†…å®¹
          # è¿™ä¸ªå‘½ä»¤ä¼šæŸ¥æ‰¾ "æˆ‘å« Privat5418" åé¢çš„ç¬¬ä¸€ä¸ª "å¾ˆé«˜å…´è®¤è¯†ä½ "ï¼Œå¹¶åœ¨å®ƒä»¬ä¹‹é—´æ’å…¥
          UPDATED_README=$(echo "$README_CONTENT" | sed -E "
            /^[![Typing SVG](https://readme-typing-svg.demolab.com?font=Fira+Code&weight=500&size=40&pause=100&vCenter=true&width=435&height=60&lines=%E6%88%91%E5%8F%AB+Privat5418)](https://git.io/typing-svg)$/ {
              :loop
              n
              /^## å¾ˆé«˜å…´è®¤è¯†ä½ $/ {
                i\\
$NEW_QUOTATION_BLOCK
                b end
              }
              b loop
            }
            :end
          ")

          # å°†æ›´æ–°åçš„å†…å®¹å†™å› README.md
          echo "$UPDATED_README" > README.md
          echo "Successfully updated README.md with the new quotation block."

      - name: Commit and push if changed
        run: |
          git diff # æ˜¾ç¤ºæ›´æ”¹
          git config --global user.email "2992253553@qq.com"
          git config --global user.name "2992253553"
          # git pull # é€šå¸¸ä¸éœ€è¦ pullï¼Œå› ä¸º actions/checkout@v4 å·²ç»æ˜¯æœ€æ–°äº†ï¼Œä¸” push ä¼šå¤„ç†å†²çª
          git add -A
          git commit -m "Auto Update Daily Quotations [skip ci]" || exit 0 # å¦‚æœæ²¡æœ‰æ›´æ”¹ï¼Œexit 0 é¿å…å¤±è´¥
          git push
