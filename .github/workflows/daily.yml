name: Daily Update
on:
  schedule:
    - cron: '0 0 * * *' # 每天 UTC 时间 00:00 运行
  workflow_dispatch: # 允许手动触发

# 关键修改：授予 GITHUB_TOKEN 写入权限 (虽然你用了 PAT，但显式声明更清晰)
permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 # 建议使用最新的 actions/checkout 版本
        with:
          token: ${{ secrets.PAT_FOR_PUSH }}

      - name: Install
        run: yarn

      - name: Update # 运行你的 daily.js 脚本，它会生成 daily_quotation_block.txt
        run: node daily.js

      # 新增步骤：读取生成的每日一言内容并插入到 README.md 的指定位置
      - name: Insert Daily Quotation into README
        run: |
          # 检查 daily_quotation_block.txt 是否存在且不为空
          if [ -f daily_quotation_block.txt ] && [ -s daily_quotation_block.txt ]; then
            # 读取 daily_quotation_block.txt 的内容
            NEW_QUOTATION_BLOCK=$(cat daily_quotation_block.txt)
            echo "Found new quotation block to insert."
          else
            echo "daily_quotation_block.txt does not exist or is empty. Skipping insertion."
            exit 0
          fi

          # 读取当前 README.md 内容
          README_CONTENT=$(cat README.md)

          # 使用 awk 在 "Privat5418的GitHub页面" 和紧随其后的 "很高兴认识你" 之间插入新内容
          # awk 脚本：
          # - 初始化 found_first=0
          # - 逐行读取
          # - 如果行是 "Privat5418的GitHub页面"，打印该行，设置 found_first=1
          # - 如果行是 "很高兴认识你" 且 found_first=1，则先打印插入内容，再打印该行，重置 found_first=0
          # - 其他行直接打印
          UPDATED_README=$(echo "$README_CONTENT" | awk '
            BEGIN { found_first = 0 }
            {
              if ($0 ~ /^Privat5418的GitHub页面$/) {
                print $0;
                found_first = 1;
              } else if ($0 ~ /^很高兴认识你$/ && found_first == 1) {
                print ENVIRON["NEW_QUOTATION_BLOCK"];
                print $0;
                found_first = 0;
              } else {
                print $0;
              }
            }
          ')

          # 将更新后的内容写回 README.md
          echo "$UPDATED_README" > README.md
          echo "Successfully updated README.md with the new quotation block."

      - name: Commit and push if changed
        run: |
          git diff # 显示更改
          git config --global user.email "2992253553@qq.com"
          git config --global user.name "2992253553"
          # git pull # 通常不需要 pull，因为 actions/checkout@v4 已经是最新了，且 push 会处理冲突
          git add -A
          git commit -m "Auto Update Daily Quotations [skip ci]" || exit 0 # 如果没有更改，exit 0 避免失败
          git push
